name: Validate Addon

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  pre-commit-checks:
    name: Pre-Commit Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: '5.1'

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install dependencies
        run: |
          npm ci
          luarocks install luacheck

      - name: Run pre-commit hook
        run: |
          chmod +x .git/hooks/pre-commit 2>/dev/null || true
          bash scripts/install-hooks.sh
          .git/hooks/pre-commit

  validate-toc:
    name: Validate TOC File
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check TOC file exists
        run: |
          if [ ! -f "LayoutLedger/LayoutLedger.toc" ]; then
            echo "Error: TOC file not found"
            exit 1
          fi

      - name: Validate TOC structure
        run: |
          TOC_FILE="LayoutLedger/LayoutLedger.toc"

          # Check for required fields
          if ! grep -q "^## Interface:" "$TOC_FILE"; then
            echo "Error: Missing ## Interface: field"
            exit 1
          fi

          if ! grep -q "^## Title:" "$TOC_FILE"; then
            echo "Error: Missing ## Title: field"
            exit 1
          fi

          if ! grep -q "^## Version:" "$TOC_FILE"; then
            echo "Error: Missing ## Version: field"
            exit 1
          fi

          # Check that all referenced files exist
          echo "Checking referenced files..."
          grep -v "^#" "$TOC_FILE" | grep -v "^$" | while read -r file; do
            if [ ! -f "LayoutLedger/$file" ]; then
              echo "Error: Referenced file not found: $file"
              exit 1
            fi
          done

          echo "✅ TOC file validation passed!"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [pre-commit-checks, validate-toc]
    if: always()

    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.pre-commit-checks.result }}" == "failure" ] || \
             [ "${{ needs.validate-toc.result }}" == "failure" ]; then
            echo "❌ Validation failed - check the logs above"
            exit 1
          else
            echo "✅ All validation checks passed!"
          fi
